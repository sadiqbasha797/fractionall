<div class="profile-container">
  <!-- Header Section -->
  <div class="profile-header">
    <h1 class="profile-title">My Profile</h1>
    <button class="edit-profile-btn" (click)="openEditModal()">
      <svg class="edit-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
        </path>
      </svg>
      <span>Edit Profile</span>
    </button>
  </div>

  <!-- Error Message -->
  <div *ngIf="error()" class="error-message" style="color: #ef4444; text-align: center; margin-bottom: 1rem; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
    {{ error() }}
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading()" class="loading-spinner" style="text-align: center; padding: 2rem;">
    <div style="display: inline-block; width: 2rem; height: 2rem; border: 3px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
    <p style="margin-top: 1rem; color: #9ca3af;">Loading profile...</p>
  </div>

  <!-- Main Content Grid -->
  <div class="profile-grid" *ngIf="!loading()">
    <!-- Left Column - User Info and Tickets/Tokens -->
    <div class="left-column">
      <!-- User Profile Card -->
      <div class="profile-card">
        <div class="profile-info">
          <div class="profile-avatar-section">
            <div class="profile-avatar">
              <img [src]="user().profileimage || 'public/person_1.jpg'" [alt]="user().name || 'Profile Image'" />
              <!-- Upload progress overlay -->
              <div *ngIf="uploadingImage()" class="upload-overlay">
                <div class="upload-spinner"></div>
              </div>
            </div>
            <button class="change-photo-btn" (click)="triggerFileInput()" [disabled]="uploadingImage()">
              <span *ngIf="uploadingImage()">Uploading...</span>
              <span *ngIf="!uploadingImage()">Change Photo</span>
            </button>
            <!-- Success message -->
            <div *ngIf="imageUploadSuccess()" class="upload-success" style="margin-top: 0.5rem; font-size: 0.75rem; color: #10b981; text-align: center;">
              {{ imageUploadSuccess() }}
            </div>
            <!-- Error message -->
            <div *ngIf="imageUploadError()" class="upload-error" style="margin-top: 0.5rem; font-size: 0.75rem; color: #ef4444; text-align: center;">
              {{ imageUploadError() }}
            </div>
          </div>
          <div class="profile-details">
            <div class="profile-details-grid">
              <div class="detail-item">
                <label class="detail-label">Full Name</label>
                <p class="detail-value">{{ user().name || 'Not provided' }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Email</label>
                <p class="detail-value">{{ user().email || 'Not provided' }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Mobile Number</label>
                <p class="detail-value">{{ user().phone || 'Not provided' }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Date of Birth</label>
                <p class="detail-value">{{ formatDate(user().dateofbirth) }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Location</label>
                <p class="detail-value">{{ user().location || 'Not provided' }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Pincode</label>
                <p class="detail-value">{{ user().pincode || 'Not provided' }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Account Status</label>
                <p class="detail-value">{{ getVerificationStatus() }}</p>
              </div>
              <div class="detail-item">
                <label class="detail-label">Member Since</label>
                <p class="detail-value">{{ formatDate(user().createdAt) }}</p>
              </div>
            </div>
            <div class="address-section">
              <label class="detail-label">Address</label>
              <p class="detail-value">{{ user().address || 'Not provided' }}</p>
            </div>
            
            <!-- Government ID Section -->
            <div class="government-id-section" style="margin-top: 1.5rem;">
              <h3 style="font-size: 1.125rem; font-weight: 600; color: #ffffff; margin-bottom: 1rem;">Government IDs</h3>
              <div class="government-id-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="detail-item">
                  <label class="detail-label">Aadhar ID</label>
                  <p class="detail-value">{{ formatGovernmentId('aadharid', user().governmentid?.aadharid) }}</p>
                </div>
                <div class="detail-item">
                  <label class="detail-label">PAN ID</label>
                  <p class="detail-value">{{ formatGovernmentId('panid', user().governmentid?.panid) }}</p>
                </div>
                <div class="detail-item">
                  <label class="detail-label">License ID</label>
                  <p class="detail-value">{{ formatGovernmentId('licenseid', user().governmentid?.licenseid) }}</p>
                </div>
                <div class="detail-item">
                  <label class="detail-label">Income</label>
                  <p class="detail-value">{{ user().governmentid?.income || 'Not provided' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile KYC Card -->
      <div class="kyc-card mobile-kyc">
        <div class="kyc-header">
          <h2 class="kyc-title">KYC Status</h2>
          <div class="kyc-status" [class]="getKycStatusClass()">
            <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
              <path d="M12 9v4"></path>
              <path d="M12 17h.01"></path>
            </svg>
            <span>{{ getKycStatusDisplay() }}</span>
          </div>
        </div>
        <p class="kyc-description">Please submit the required documents to get your account verified and access all features.</p>
        <button class="submit-docs-btn" (click)="openDocModal()" *ngIf="user().kycStatus === 'pending'">Submit Documents</button>
      </div>

      <!-- My Shares Section -->
      <div class="tickets-card">
        <h2 class="section-title">My Shares</h2>
        
        <!-- Loading state -->
        <div *ngIf="ticketsLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading shares...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="ticketsError() && !ticketsLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ ticketsError() }}
        </div>

        <!-- Contract Documents Loading state -->
        <div *ngIf="contractDocumentsLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading contract documents...</p>
        </div>

        <!-- Contract Documents Error state -->
        <div *ngIf="contractDocumentsError() && !contractDocumentsLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ contractDocumentsError() }}
        </div>



        <!-- No shares state -->
        <div *ngIf="!ticketsLoading() && !ticketsError() && tickets().length === 0" class="no-tickets" style="text-align: center; padding: 2rem; color: #9ca3af;">
          <p>No shares found. You haven't purchased any shares yet.</p>
        </div>

        <!-- Shares grid -->
        <div class="tickets-grid" *ngIf="!ticketsLoading() && !ticketsError() && tickets().length > 0">
          <div *ngFor="let ticket of tickets()" class="ticket-item" [class.expired]="ticket.ticketstatus === 'expired'">
            <!-- Car Image -->
            <div class="ticket-car-image" *ngIf="ticket.carid">
              <img [src]="ticket.carid.images && ticket.carid.images.length > 0 ? ticket.carid.images[0] : 'public/car.png'" [alt]="ticket.carid.carname" />
            </div>
            <div class="ticket-header">
              <span class="ticket-type">SHARE #{{ ticket.ticketcustomid }}</span>
              <span class="ticket-status" [class.active]="ticket.ticketstatus === 'active'" [class.expired]="ticket.ticketstatus === 'expired'">
                {{ ticket.ticketstatus | titlecase }}
              </span>
            </div>
            <p class="ticket-id">Share ID: {{ ticket._id }}</p>
            <p class="ticket-model" *ngIf="ticket.carid">{{ ticket.carid.carname }}</p>
            <p class="ticket-brand" *ngIf="ticket.carid">{{ ticket.carid.brandname }} - {{ ticket.carid.color }}</p>
            <div class="ticket-dates">
              <div class="date-item">Expires: <span>{{ formatDate(ticket.ticketexpiry) }}</span></div>
              <div class="date-item">Purchased: <span>{{ formatDate(ticket.ticketbroughtdate) }}</span></div>
            </div>
            <div class="ticket-pricing">
              <div class="price-item">Total Price: <span>‚Çπ{{ ticket.ticketprice }}</span></div>
              <div class="price-item">Paid: <span>‚Çπ{{ ticket.pricepaid }}</span></div>
              <div class="price-item" *ngIf="ticket.pendingamount > 0">Pending: <span>‚Çπ{{ ticket.pendingamount }}</span></div>
            </div>
            <div class="ticket-comments" *ngIf="ticket.comments">
              <p><strong>Comments:</strong> {{ ticket.comments }}</p>
            </div>
            
            <!-- Contract Documents Section -->
            <div class="contract-documents-section" *ngIf="ticket._id && getContractDocumentsForTicket(ticket._id).length > 0">
              <h4 class="contract-documents-title">Contract Documents</h4>
              <div class="contract-documents-list">
                <div *ngFor="let contract of getContractDocumentsForTicket(ticket._id || '')" class="contract-item">
                  <div *ngFor="let doc of contract.contract_docs; let i = index" class="document-item">
                    <div class="document-info">
                      <svg class="document-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      <span class="document-name">Contract Document {{ i + 1 }}</span>
                    </div>
                    <button class="download-btn" (click)="downloadContractDocument(contract._id, i, contract.ticketid.ticketcustomid, contract.carid.carname)" *ngIf="contract._id && contract.ticketid.ticketcustomid && contract.carid.carname">
                      <svg class="download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      Download
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Waitlist Section -->
      <div class="tokens-card">
        <h2 class="section-title">My Waitlist</h2>
        
        <!-- Loading state -->
        <div *ngIf="tokensLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading waitlist...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="tokensError() && !tokensLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ tokensError() }}
        </div>

        <!-- No waitlist state -->
        <div *ngIf="!tokensLoading() && !tokensError() && tokens().length === 0" class="no-tokens" style="text-align: center; padding: 2rem; color: #9ca3af;">
          <p>No waitlist items found. You haven't joined any waitlist yet.</p>
        </div>

        <!-- Waitlist grid -->
        <div class="tokens-grid" *ngIf="!tokensLoading() && !tokensError() && tokens().length > 0">
          <div *ngFor="let token of tokens()" class="token-item" [class.expired]="token.status === 'expired'">
            <!-- Car Image -->
            <div class="token-car-image" *ngIf="token.carid">
              <img [src]="token.carid.images && token.carid.images.length > 0 ? token.carid.images[0] : 'public/car.png'" [alt]="token.carid.carname" />
            </div>
            <div class="ticket-header">
              <span class="ticket-type">WAITLIST #{{ token.customtokenid }}</span>
              <span class="ticket-status" [class.active]="token.status === 'active'" [class.expired]="token.status === 'expired'">
                {{ token.status | titlecase }}
              </span>
            </div>
            <p class="ticket-id">Waitlist ID: {{ token._id }}</p>
            <p class="ticket-model" *ngIf="token.carid">{{ token.carid.carname }}</p>
            <p class="ticket-brand" *ngIf="token.carid">{{ token.carid.brandname }} - {{ token.carid.color }}</p>
            <div class="ticket-dates">
              <div class="date-item">Expires: <span>{{ formatDate(token.expirydate) }}</span></div>
              <div class="date-item">Purchased: <span>{{ formatDate(token.date) }}</span></div>
            </div>
            <div class="ticket-pricing">
              <div class="price-item">Amount Paid: <span>‚Çπ{{ token.amountpaid }}</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Book Now Tokens Section -->
      <div class="booknow-tokens-card">
        <h2 class="section-title">My Book Now Tokens</h2>
        
        <!-- Loading state -->
        <div *ngIf="bookNowTokensLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading book now tokens...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="bookNowTokensError() && !bookNowTokensLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ bookNowTokensError() }}
        </div>

        <!-- No book now tokens state -->
        <div *ngIf="!bookNowTokensLoading() && !bookNowTokensError() && bookNowTokens().length === 0" class="no-booknow-tokens" style="text-align: center; padding: 2rem; color: #9ca3af;">
          <p>No book now tokens found. You haven't purchased any book now tokens yet.</p>
        </div>

        <!-- Book now tokens grid -->
        <div class="booknow-tokens-grid" *ngIf="!bookNowTokensLoading() && !bookNowTokensError() && bookNowTokens().length > 0">
          <div *ngFor="let bookNowToken of bookNowTokens()" class="booknow-token-item" [class.expired]="bookNowToken.status === 'expired'">
            <!-- Car Image -->
            <div class="booknow-token-car-image" *ngIf="bookNowToken.carid">
              <img [src]="bookNowToken.carid.images && bookNowToken.carid.images.length > 0 ? bookNowToken.carid.images[0] : 'public/car.png'" [alt]="bookNowToken.carid.carname" />
            </div>
            <div class="ticket-header">
              <span class="ticket-type">BOOK NOW TOKEN #{{ bookNowToken.customtokenid }}</span>
              <span class="ticket-status" [class.active]="bookNowToken.status === 'active'" [class.expired]="bookNowToken.status === 'expired'" [class.dropped]="bookNowToken.status === 'dropped'">
                {{ bookNowToken.status | titlecase }}
              </span>
            </div>
            <p class="ticket-id">Token ID: {{ bookNowToken._id }}</p>
            <p class="ticket-model" *ngIf="bookNowToken.carid">{{ bookNowToken.carid.carname }}</p>
            <p class="ticket-brand" *ngIf="bookNowToken.carid">{{ bookNowToken.carid.brandname }} - {{ bookNowToken.carid.color }}</p>
            <div class="ticket-dates">
              <div class="date-item">Expires: <span>{{ formatDate(bookNowToken.expirydate) }}</span></div>
              <div class="date-item">Purchased: <span>{{ formatDate(bookNowToken.date) }}</span></div>
            </div>
            <div class="ticket-pricing">
              <div class="price-item">Amount Paid: <span>‚Çπ{{ bookNowToken.amountpaid }}</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - KYC and Calendar -->
    <div class="right-column">
      <!-- Desktop KYC Card -->
      <div class="kyc-card desktop-kyc">
        <div class="kyc-header">
          <h2 class="kyc-title">KYC Status</h2>
          <div class="kyc-status" [class]="getKycStatusClass()">
            <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
              <path d="M12 9v4"></path>
              <path d="M12 17h.01"></path>
            </svg>
            <span>{{ getKycStatusDisplay() }}</span>
          </div>
        </div>
        <p class="kyc-description">Please submit the required documents to get your account verified and access all features.</p>
        <button class="submit-docs-btn" (click)="openDocModal()" *ngIf="user().kycStatus === 'pending'">Submit Documents</button>
      </div>

      <!-- Calendar/Bookings Card -->
      <div class="calendar-card">
        <div class="calendar-header-section">
          <h2 class="section-title">My Bookings</h2>
          <button class="book-now-btn" (click)="navigateToBookings()">
            Book Now
          </button>
        </div>
        
        <!-- Loading state -->
        <div *ngIf="bookingsLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading bookings...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="bookingsError() && !bookingsLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ bookingsError() }}
        </div>

        <!-- Calendar -->
        <div class="calendar-container" *ngIf="!bookingsLoading() && !bookingsError()">
          <div class="calendar-header">
            <button class="calendar-nav-btn" (click)="goToPreviousMonth()">
              <svg fill="currentColor" viewBox="0 0 256 256">
                <path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path>
              </svg>
            </button>
            <p class="calendar-month">{{ getCurrentMonthDisplay() }}</p>
            <button class="calendar-nav-btn" (click)="goToNextMonth()">
              <svg fill="currentColor" viewBox="0 0 256 256">
                <path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path>
              </svg>
            </button>
          </div>
          <div class="calendar-weekdays">
            <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
          </div>
          <div class="calendar-days">
            <div *ngFor="let day of calendarDays()" 
                 [class]="getCalendarDayClass(day)"
                 [title]="getBookingTooltip(day)">
              {{ day.day }}
            </div>
          </div>
        </div>

        <!-- No bookings state -->
        <div *ngIf="!bookingsLoading() && !bookingsError() && bookings().length === 0" class="no-bookings" style="text-align: center; padding: 2rem; color: #9ca3af;">
          <p>No bookings found. You haven't made any bookings yet.</p>
        </div>
      </div>

      <!-- AMC Section -->
      <div class="amc-card">
        <h2 class="section-title">AMC Records</h2>
        
        <!-- Loading state -->
        <div *ngIf="amcsLoading()" class="loading-spinner" style="text-align: center; padding: 1rem;">
          <div style="display: inline-block; width: 1.5rem; height: 1.5rem; border: 2px solid #4a5568; border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite;"></div>
          <p style="margin-top: 0.5rem; color: #9ca3af; font-size: 0.875rem;">Loading AMC records...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="amcsError() && !amcsLoading()" class="error-message" style="color: #ef4444; text-align: center; margin: 1rem 0; padding: 1rem; background-color: rgba(239, 68, 68, 0.1); border-radius: 0.5rem;">
          {{ amcsError() }}
        </div>

        <!-- No AMC state -->
        <div *ngIf="!amcsLoading() && !amcsError() && amcs().length === 0" class="no-amcs" style="text-align: center; padding: 2rem; color: #9ca3af;">
          <p>No AMC records found. You don't have any AMC contracts yet.</p>
        </div>

        <!-- AMC cards -->
        <div class="amc-cards" *ngIf="!amcsLoading() && !amcsError() && amcs().length > 0">
          <div *ngFor="let amc of amcs()" class="amc-card-item" [class.expanded]="isAMCExpanded(amc._id!)">
            <!-- AMC Card Header -->
            <div class="amc-card-header" (click)="toggleAMCExpansion(amc._id!)">
              <div class="amc-car-info">
                <div class="amc-car-image">
                  <img [src]="amc.carid.images && amc.carid.images[0] || 'public/car.png'" [alt]="amc.carid.carname" />
                </div>
                <div class="amc-car-details">
                  <h3 class="amc-car-name">{{ amc.carid.carname }}</h3>
                  <p class="amc-car-brand">{{ amc.carid.brandname }} - {{ amc.carid.color }}</p>
                  <p class="amc-ticket-info">Ticket: #{{ amc.ticketid.ticketcustomid }}</p>
                </div>
              </div>
              <div class="amc-amount-info">
                <div class="amc-total-amount">
                  <span class="amount-label">Total AMC:</span>
                  <span class="amount-value">‚Çπ{{ getTotalAMCAmount(amc) }}</span>
                </div>
                <div class="amc-paid-amount">
                  <span class="amount-label">Paid:</span>
                  <span class="amount-value paid">‚Çπ{{ getPaidAMCAmount(amc) }}</span>
                </div>
                <div class="amc-pending-amount">
                  <span class="amount-label">Pending:</span>
                  <span class="amount-value pending">‚Çπ{{ getPendingAMCAmount(amc) }}</span>
                </div>
                <div class="amc-expand-icon">
                  <svg [class.rotated]="isAMCExpanded(amc._id!)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- AMC Details (Expandable) -->
            <div class="amc-details" *ngIf="isAMCExpanded(amc._id!)">
              <div class="amc-details-header">
                <h4>AMC Payment History</h4>
                <div class="amc-next-due" *ngIf="getNextDueAMC(amc)">
                  <span class="next-due-label">Next Due:</span>
                  <span class="next-due-amount">‚Çπ{{ getNextDueAMC(amc).amount }}</span>
                  <span class="next-due-date" *ngIf="getNextDueAMC(amc).duedate">by {{ formatDate(getNextDueAMC(amc).duedate) }}</span>
                </div>
              </div>
              
              <div class="amc-records">
                <div *ngFor="let amount of amc.amcamount; let i = index" class="amc-record" [class.paid]="amount.paid" [class.overdue]="isAMCAmountOverdue(amount)">
                  <div class="amc-record-header">
                    <div class="amc-year">
                      <span class="year-label">Year {{ amount.year }}</span>
                      <span class="amount">‚Çπ{{ amount.amount }}</span>
                    </div>
                    <div class="amc-status">
                      <span class="status-badge" [class.paid]="amount.paid" [class.pending]="!amount.paid">
                        {{ amount.paid ? 'Paid' : 'Pending' }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="amc-record-details">
                    <div class="amc-due-date" *ngIf="amount.duedate">
                      <span class="detail-label">Due Date:</span>
                      <span class="detail-value">{{ formatDate(amount.duedate) }}</span>
                    </div>
                    <div class="amc-paid-date" *ngIf="amount.paiddate">
                      <span class="detail-label">Paid Date:</span>
                      <span class="detail-value">{{ formatDate(amount.paiddate) }}</span>
                    </div>
                    <div class="amc-penalty" *ngIf="amount.penality > 0">
                      <span class="detail-label">Penalty:</span>
                      <span class="detail-value penalty">‚Çπ{{ amount.penality }}</span>
                    </div>
                    
                    <!-- Payment Button -->
                    <div class="amc-payment-section" *ngIf="!amount.paid">
                      <div class="test-mode-notice">
                        <small class="text-yellow-400">üí≥ Test Mode - Pay ‚Çπ1 (Actual: ‚Çπ{{ amount.amount }})</small>
                      </div>
                      <button 
                        class="amc-pay-btn"
                        (click)="initiateAMCPayment(amc, i)"
                        [disabled]="isAMCPaymentLoading() || !razorpayKey()"
                        [class.loading]="isAMCPaymentLoading()">
                        <span *ngIf="isAMCPaymentLoading()">Processing...</span>
                        <span *ngIf="!isAMCPaymentLoading()">Pay ‚Çπ1 (Test Mode)</span>
                      </button>
                      <div class="test-amount-notice">
                        <small class="text-blue-400">‚ÑπÔ∏è Test payment of ‚Çπ1 will mark this AMC as paid</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KYC Document Modal -->
  <div *ngIf="showDocModal()" class="modal-overlay" (click)="closeDocModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Submit Documents</h3>
        <button class="modal-close-btn" (click)="closeDocModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form class="kyc-form" (ngSubmit)="onSubmitKyc()">
        <div class="form-group">
          <label class="form-label">Aadhar ID</label>
          <input type="text" class="form-input" [ngModel]="kycForm().aadharId" (ngModelChange)="updateKycAadharId($event)" name="aadharId" placeholder="Enter your 12-digit Aadhar number" maxlength="12" (input)="onAadharIdChange()" required>
          <div *ngIf="aadharError()" class="field-error">{{ aadharError() }}</div>
        </div>
        <div class="form-group">
          <label class="form-label">PAN ID</label>
          <input type="text" class="form-input" [ngModel]="kycForm().panId" (ngModelChange)="updateKycPanId($event)" name="panId" placeholder="Enter your PAN number (e.g., ABCDE1234F)" maxlength="10" (input)="onPanIdChange()" required>
          <div *ngIf="panError()" class="field-error">{{ panError() }}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Upload Documents (PDF)</label>
          <input type="file" class="form-file" (change)="onFileSelect($event)" accept=".pdf" required>
          <div class="file-help-text">Upload a single PDF containing both Aadhar and PAN card images</div>
          <div *ngIf="fileInfo()" class="file-info">{{ fileInfo() }}</div>
          <div *ngIf="fileError()" class="file-error">{{ fileError() }}</div>
        </div>
        <button type="submit" class="submit-btn" [disabled]="submittingKyc()">
          <span *ngIf="submittingKyc()">Submitting...</span>
          <span *ngIf="!submittingKyc()">Submit Documents</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div *ngIf="showEditModal()" class="modal-overlay" (click)="closeEditModal()">
    <div class="edit-modal-content" (click)="$event.stopPropagation()">
      <div class="edit-modal-header">
        <h3 class="edit-modal-title">Edit Profile</h3>
        <button class="edit-modal-close-btn" (click)="closeEditModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="edit-modal-body">
        <form class="edit-form" (ngSubmit)="saveProfile()">
          <!-- Alert Messages -->
          <div *ngIf="editErrorMessage()" class="alert-error">{{ editErrorMessage() }}</div>
          <div *ngIf="editSuccessMessage()" class="alert-success">{{ editSuccessMessage() }}</div>

          <!-- Personal Information Section -->
          <div class="form-row">
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üë§</span> Full Name
              </label>
              <input type="text" class="form-input-enhanced" [ngModel]="editForm().name" (ngModelChange)="updateEditFormName($event)" name="name" placeholder="Enter your full name" required>
            </div>
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üìß</span> Email Address
              </label>
              <input type="email" class="form-input-enhanced" [ngModel]="editForm().email" (ngModelChange)="updateEditFormEmail($event)" name="email" placeholder="Enter your email" required>
              <div class="form-help-text">Changing email requires verification</div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üì±</span> Mobile Number
              </label>
              <input type="tel" class="form-input-enhanced" [ngModel]="editForm().phone" (ngModelChange)="updateEditFormPhone($event)" name="phone" placeholder="Enter mobile number">
            </div>
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üéÇ</span> Date of Birth
              </label>
              <input type="date" class="form-input-enhanced" [ngModel]="editForm().dateofbirth" (ngModelChange)="updateEditFormDateOfBirth($event)" name="dateofbirth">
            </div>
          </div>

          <!-- Location Information Section -->
          <div class="form-row">
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üìç</span> Location
              </label>
              <input type="text" class="form-input-enhanced" [ngModel]="editForm().location" (ngModelChange)="updateEditFormLocation($event)" name="location" placeholder="City, State">
            </div>
            <div class="form-group-enhanced">
              <label class="form-label-enhanced">
                <span>üìÆ</span> Pincode
              </label>
              <input type="text" class="form-input-enhanced" [ngModel]="editForm().pincode" (ngModelChange)="updateEditFormPincode($event)" name="pincode" placeholder="Enter pincode" maxlength="6">
            </div>
          </div>

          <div class="form-group-enhanced">
            <label class="form-label-enhanced">
              <span>üè†</span> Address
            </label>
            <textarea class="form-input-enhanced" [ngModel]="editForm().address" (ngModelChange)="updateEditFormAddress($event)" name="address" placeholder="Enter your full address" rows="2" style="resize: vertical; min-height: 3rem;"></textarea>
          </div>

          <!-- Add some bottom spacing -->
          <div style="height: 1rem;"></div>
        </form>
      </div>

      <div class="edit-modal-actions">
        <button type="button" class="btn-secondary-enhanced" (click)="openChangePasswordModal()">
          <span>üîê</span> Change Password
        </button>
        <button type="submit" class="btn-primary-enhanced" (click)="saveProfile()" [disabled]="editSubmitting()">
          <span *ngIf="editSubmitting()">üíæ Saving...</span>
          <span *ngIf="!editSubmitting()">üíæ Save Changes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Verify Email Modal -->
  <div *ngIf="showVerifyEmailModal()" class="modal-overlay" (click)="closeVerifyEmailModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Verify New Email</h3>
        <button class="modal-close-btn" (click)="closeVerifyEmailModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form class="kyc-form" (ngSubmit)="verifyNewEmail()">
        <div *ngIf="verifyErrorMessage()" class="field-error">{{ verifyErrorMessage() }}</div>
        <div *ngIf="verifySuccessMessage()" class="file-info" style="color:#10b981">{{ verifySuccessMessage() }}</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" [ngModel]="verifyForm().email" (ngModelChange)="updateVerifyFormEmail($event)" name="verifyEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">Verification Code</label>
          <input type="text" class="form-input" [ngModel]="verifyForm().code" (ngModelChange)="updateVerifyFormCode($event)" name="verifyCode" maxlength="6" required>
        </div>
        <div style="display:flex; gap:0.5rem">
          <button type="submit" class="submit-btn" [disabled]="verifySubmitting()">
            <span *ngIf="verifySubmitting()">Verifying...</span>
            <span *ngIf="!verifySubmitting()">Verify</span>
          </button>
          <button type="button" class="submit-btn" style="background:#374151" (click)="resendVerifyCode()" [disabled]="verifySubmitting()">Resend Code</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div *ngIf="showChangePasswordModal()" class="modal-overlay" (click)="closeChangePasswordModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Change Password</h3>
        <button class="modal-close-btn" (click)="closeChangePasswordModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form class="kyc-form" (ngSubmit)="submitNewPassword()">
        <div *ngIf="passwordErrorMessage()" class="field-error">{{ passwordErrorMessage() }}</div>
        <div *ngIf="passwordSuccessMessage()" class="file-info" style="color:#10b981">{{ passwordSuccessMessage() }}</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" [ngModel]="user().email" name="resetEmail" disabled>
        </div>
        <div class="form-group" style="display:flex; gap:0.5rem; align-items:center">
          <div style="flex:1">
            <label class="form-label">Reset Code</label>
            <input type="text" class="form-input" [ngModel]="resetForm().code" (ngModelChange)="updateResetFormCode($event)" name="resetCode" maxlength="6" required>
          </div>
          <button type="button" class="submit-btn" style="margin-top:1.6rem" (click)="requestPasswordCode()" [disabled]="passwordRequesting()">{{ passwordRequesting() ? 'Sending...' : 'Send Code' }}</button>
        </div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" class="form-input" [ngModel]="resetForm().newPassword" (ngModelChange)="updateResetFormPassword($event)" name="newPassword" minlength="6" required>
        </div>
        <button type="submit" class="submit-btn" [disabled]="passwordSubmitting">
          <span *ngIf="passwordSubmitting">Changing...</span>
          <span *ngIf="!passwordSubmitting">Change Password</span>
        </button>
      </form>
    </div>
  </div>

  <!-- AMC Payment Success Modal -->
  <div *ngIf="showAMCPaymentModal()" class="modal-overlay" (click)="closeAMCPaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Payment Successful!</h3>
        <button class="modal-close-btn" (click)="closeAMCPaymentModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="success-icon">
          <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <div class="success-message">
          <h4 class="text-lg font-semibold text-white mb-2">AMC Payment Completed!</h4>
          <p class="text-gray-300 mb-4">
            Your AMC payment for <strong>{{ selectedAMC()?.carid?.carname }}</strong> 
            (Year {{ selectedAMC()?.amcamount?.[selectedAMCYear()]?.year }}) has been processed successfully.
          </p>
          <div class="payment-details">
            <div class="detail-row">
              <span class="detail-label">Test Payment:</span>
              <span class="detail-value">‚Çπ1 (Test Mode)</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Actual Amount:</span>
              <span class="detail-value">‚Çπ{{ getAMCPaymentAmount(selectedAMC()!, selectedAMCYear()) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Payment Date:</span>
              <span class="detail-value">{{ getCurrentDate() }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="detail-value success">Paid</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeAMCPaymentModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- AMC Payment Error Display -->
  <div *ngIf="amcPaymentError()" class="error-message" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px; background-color: #ef4444; color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <span>{{ amcPaymentError() }}</span>
      </div>
      <button (click)="amcPaymentError.set('')" class="ml-4 text-white hover:text-gray-200">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* AMC Payment Button Styles */
.amc-payment-section {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #374151;
}

.test-mode-notice {
  margin-bottom: 0.5rem;
  text-align: center;
}

.amount-limit-notice {
  margin-top: 0.5rem;
  text-align: center;
}

.test-amount-notice {
  margin-top: 0.5rem;
  text-align: center;
}

.amc-pay-btn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
}

.amc-pay-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #1d4ed8, #1e40af);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
}

.amc-pay-btn:disabled {
  background: #6b7280;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.amc-pay-btn.loading {
  background: #6b7280;
  cursor: not-allowed;
}

/* Payment Success Modal Styles */
.success-icon {
  text-align: center;
  margin-bottom: 1rem;
}

.success-message {
  text-align: center;
}

.payment-details {
  background-color: #1f2937;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-top: 1rem;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.detail-row:last-child {
  margin-bottom: 0;
}

.detail-label {
  color: #9ca3af;
  font-size: 0.875rem;
}

.detail-value {
  color: #ffffff;
  font-weight: 600;
}

.detail-value.success {
  color: #10b981;
}

.modal-actions {
  display: flex;
  justify-content: center;
  margin-top: 1.5rem;
}

.btn-primary {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 0.75rem 2rem;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.btn-primary:hover {
  background: #2563eb;
}
</style>
